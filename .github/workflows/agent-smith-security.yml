name: ğŸ¤– Agent Smith Security Pipeline
on:
  push:
    branches: [ "master", "develop" ]
  pull_request:
    branches: [ "master" ]
  schedule:
    - cron: '0 2 * * 1'  # Weekly security scan

env:
  # PlatformIO specifics
  PIO_VERSION: '6.1.13'

jobs:
  security-scan:
    name: ğŸ” Security Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
    - name: ğŸ”„ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ” Secret Scanning (TruffleHog)
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.repository.default_branch }}
        head: HEAD
        extra_args: --debug --only-verified
    
    - name: ğŸ” Cppcheck Analysis
      uses: deep5050/cppcheck-action@main
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        check_library: true
        enable: all
        inconclusive: true
        inline_suppression: true
        force_language: c++

  dependency-security:
    name: ğŸ“¦ Dependency Security
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: ğŸ” Dependency Review
      uses: actions/dependency-review-action@v4
      if: github.event_name == 'pull_request'
      with:
        fail-on-severity: high

  quality-gate:
    name: ğŸšª Quality Gate
    runs-on: ubuntu-latest
    needs: [security-scan, dependency-security]
    if: always()
    steps:
    - name: âœ… Security Gate Decision
      run: |
        echo "ğŸ¤– Agent Smith evaluating security posture..."
        if [ "${{ needs.security-scan.result }}" == "success" ] && 
           [ "${{ needs.dependency-security.result }}" == "success" ] ||
           [ "${{ needs.dependency-security.result }}" == "skipped" ]; then
          echo "âœ… Security gates passed - deployment/merge authorized"
        else
          echo "âŒ Security violations detected - pipeline interrupted"
          exit 1
        fi
